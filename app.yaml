cat << 'EOF' > app.yaml
name: lot-systems-dev
region: nyc3
services:
  - name: web
    git:
      branch: master
      repo_clone_url: https://github.com/vadikmarmeladov/lot-systems.git
    build_command: |
        echo "Starting build process..."
  
  # Debug initial state
  echo "Initial directory structure:"
  pwd
  ls -la
  
  # Install all required dependencies first
  echo "Installing dependencies..."
  yarn add -D postcss-import tailwindcss@latest postcss@latest autoprefixer@latest
  yarn add -D postcss-nesting @tailwindcss/nesting esbuild vite
  yarn install --frozen-lockfile --production=false || exit 1
  
  # Install global packages
  echo "Installing global packages..."
  yarn global add postcss-cli esbuild-runner typescript-esbuild || exit 1
  
  # Create all necessary directories
  echo "Creating build directories..."
  mkdir -p dist/client/css dist/server/server
  
  # Build steps with explicit error checking and path aliases
  echo "Building client CSS..."
  NODE_ENV=production yarn run client:css:build
  if [ $? -ne 0 ]; then
    echo "Client CSS build failed"
    exit 1
  fi
  
  echo "Building client JS..."
  NODE_ENV=production yarn run client:js:build
  if [ $? -ne 0 ]; then
    echo "Client JS build failed"
    exit 1
  fi
  
  echo "Building server..."
  NODE_ENV=production yarn run server:build
  if [ $? -ne 0 ]; then
    echo "Server build failed"
    exit 1
  fi
  
  # Verify build outputs with new path structure
  echo "Verifying build outputs..."
  ls -la dist/
  ls -la dist/client/css/
  ls -la dist/server/server/
  
  if [ ! -f "dist/server/server/server/index.js" ]; then
    echo "Error: Server build output missing"
    exit 1
  fi
  
  if [ ! -f "dist/client/css/index.css" ]; then
    echo "Error: CSS build output missing"
    exit 1
  fi
  
  # Run migrations
  echo "Running migrations..."
  NODE_ENV=production DATABASE_URL="postgresql://doadmin:AVNS_8V6Hqzuxwj0JkMxgNvR@db-postgresql-nyc3-92053-do-user-22640384-0.f.db.ondigitalocean.com:25060/defaultdb?sslmode=require" yarn run migrations:up || exit 1
  
  echo "Build process completed successfully"
    run_command: node dist/server/server/index.js
    environment_slug: node-js
    instance_size_slug: basic-xxs
    instance_count: 1
    envs:
      - key: NODE_ENV
        scope: RUN_AND_BUILD_TIME
        value: production
      - key: DATABASE_URL
        scope: RUN_AND_BUILD_TIME
        value: "postgresql://doadmin:AVNS_8V6Hqzuxwj0JkMxgNvR@db-postgresql-nyc3-92053-do-user-22640384-0.f.db.ondigitalocean.com:25060/defaultdb?sslmode=require"
      - key: PORT
        scope: RUN_TIME
        value: "8080"
      - key: APP_NAME
        scope: RUN_TIME
        value: "LOT Systems"
      - key: APP_HOST
        scope: RUN_TIME
        value: "${_self.PUBLIC_URL}"
      - key: JWT_SECRET
        scope: RUN_AND_BUILD_TIME
        value: "13919320b2a8816ced947b7a6385811b"
      - key: RESEND_API_KEY
        scope: RUN_TIME
        value: "re_83s23f6W_LbDfdmmXpXJ4je4i2kt1HA7u"
      - key: RESEND_FROM_EMAIL
        scope: RUN_TIME
        value: "support@lot-systems.com"
      - key: RESEND_FROM_NAME
        scope: RUN_TIME
        value: "LOT Systems"
EOF